<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8'>
  <title>meemoo/metronome @ GitHub</title>
  <meta name="author" content="sembiki.com">
  <meta name="description" content="meemoo.js module for rhythm in bpm or ms" />
  
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.3/jquery.min.js"></script>
  <script src="/meemoo/meemoo.js"></script>
</head>
<body>
  
  
  <input id="bpm" type="number" min="0" max="500" value="120" />
  <label for="bpm">bpm</label>
  =
  <input id="ms" type="number" min="120" value="500" />
  <label for="ms">ms</label>
  
  <button type="button" id="start">start</button>
  <button type="button" id="stop">stop</button>
  
  <script type="text/javascript">
  
  $(document).ready(function() {
    
    $meemoo.ready();
    
    var parentWindow, meemoo_bpm, meemoo_ms, loopInterval, setBpm, setMs, setLoop, doLoop, recieveMessage, postMessageToSib;
    
    parentWindow = window.opener ? window.opener : window.parent ? window.parent : void 0;
    
    meemoo_bpm = $("#bpm").val();
    meemoo_ms = $("#ms").val();
    
    $("#bpm").change(function(){
      setBpm($(this).val());
    });
    
    $("#ms").change(function(){
      setMs($(this).val());
    });
    
    $("#start").click(function(){
      setLoop(meemoo_ms);
    });
    
    $("#stop").click(function(){
      clearInterval(loopInterval);
    });
    
    setBpm = function(val){
      meemoo_bpm = parseInt(val);
      meemoo_ms = parseInt(1000 / meemoo_bpm * 60);
      $("#ms").val(meemoo_ms);
      setLoop(meemoo_ms);
    };
    
    setMs = function(val){
      meemoo_ms = parseInt(val);
      meemoo_bpm = parseInt(1000 / meemoo_ms * 60);
      $("#bpm").val(meemoo_bpm);
      setLoop(meemoo_ms);
    };
    
    setLoop = function(val){
      clearInterval(loopInterval);
      loopInterval = setInterval(doLoop, val);
    };
    
    doLoop = function(){
      postMessageToSib("/beat");
    };
    
    recieveMessage = function(e) {
      var action, message, messages, value, _i, _len;
      message = e.data.split("/");
      action = message[1];
      value = message[2];
      
      switch (action) {
        case "setBpm":
          setBpm(value);
        case "setMs":
          setMs(value);
      }
    };
    window.addEventListener("message", recieveMessage, false);
    
    postMessageToSib = function(message) {
      var sib = parentWindow.frames[1];
      if (sib) {
        sib.postMessage(message, "*")
      }
    };
    
  });
  
  </script>
  
</body>
</html>
